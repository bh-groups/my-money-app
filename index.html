<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenith Finance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f7ff; /* A very light lavender */
        }
        .card {
            background-color: white;
            border-radius: 1.25rem; /* More rounded corners */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .main-card {
            color: white;
            background: linear-gradient(135deg, #8A2BE2 0%, #FF69B4 100%);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6D28D9 0%, #A93B9A 100%);
            color: white;
            box-shadow: 0 4px 15px -3px rgba(109, 40, 217, 0.5);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px -5px rgba(109, 40, 217, 0.6);
        }
        .btn-danger {
            background-color: #fee2e2;
            color: #ef4444;
            padding: 0.375rem 0.625rem;
            font-size: 0.875rem;
            border-radius: 9999px;
        }
         .btn-danger:hover {
            background-color: #fecaca;
            color: #dc2626;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            border-radius: 0.75rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #8A2BE2;
            box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.2);
        }
        .icon-bg {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Hello!</h1>
                <p class="text-gray-500">Track your financial activity.</p>
            </div>
             <div class="flex items-center gap-4">
                <button id="export-btn" class="text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                </button>
                <img src="https://placehold.co/40x40/E2D9FF/6D28D9?text=U" class="rounded-full" alt="User Avatar">
            </div>
        </header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Dashboard & Form -->
            <div class="lg:col-span-1 flex flex-col gap-8">
                <!-- Main Dashboard Card -->
                <div class="card main-card">
                    <p class="text-lg opacity-80">Cash in Hand</p>
                    <p id="cash-in-hand" class="text-4xl font-extrabold tracking-tight mt-1 mb-6">₹0.00</p>
                    <div class="flex justify-between items-center text-sm">
                        <div class="flex items-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-80"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                             <span>VISA</span>
                        </div>
                        <p class="font-semibold tracking-wider">**** 5543</p>
                    </div>
                </div>

                <!-- Income, Expense, EMI cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 gap-4">
                    <div class="card flex justify-between items-center">
                        <div>
                            <p class="font-medium text-gray-500">Income</p>
                            <p id="total-income" class="text-2xl font-bold text-gray-800">₹0.00</p>
                        </div>
                        <div class="text-green-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 17h-4v-4h4v4Z"/><path d="M17 7h-4v4h4V7Z"/><path d="M7 17h4v-4H7v4Z"/><path d="M7 7h4v4H7V7Z"/></svg>
                        </div>
                    </div>
                    <div class="card flex justify-between items-center">
                        <div>
                            <p class="font-medium text-gray-500">Expenses</p>
                            <p id="total-expenses" class="text-2xl font-bold text-gray-800">₹0.00</p>
                        </div>
                        <div class="text-red-500">
                             <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                        </div>
                    </div>
                     <div class="card flex justify-between items-center">
                        <div>
                            <p class="font-medium text-gray-500">EMIs</p>
                            <p id="total-emis" class="text-2xl font-bold text-gray-800">₹0.00</p>
                        </div>
                        <div class="text-yellow-500">
                           <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m16 4 3 3-1.5 1.5-3-3L16 4Z"/><path d="m2.5 21.5 3-3L4 17l-3 3 1.5 1.5Z"/><path d="M12 2a10 10 0 1 1 0 20 10 10 0 0 1 0-20Z"/><path d="M12 12a10 10 0 0 0-4.4 8.2"/><path d="M12 12a10 10 0 0 1 4.4 8.2"/></svg>
                        </div>
                    </div>
                </div>

                <!-- Add Transaction Form -->
                <div class="card">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">New Transaction</h2>
                    <form id="transaction-form" class="space-y-4">
                        <select id="type" class="form-select">
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                            <option value="emi">EMI</option>
                        </select>
                        <input type="text" id="name" class="form-input" placeholder="Name / Description" required>
                        <div id="expense-category-field">
                            <select id="category" class="form-select">
                                <option value="Food">Food</option>
                                <option value="Transport">Transport</option>
                                <option value="Utilities">Utilities</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Health">Health</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <input type="number" id="amount" class="form-input" placeholder="Amount" required min="0.01" step="0.01">
                        <div id="emi-fields" class="hidden space-y-4">
                            <input type="number" id="emi-total" class="form-input" placeholder="Total Loan Amount" min="0.01" step="0.01">
                            <input type="number" id="emi-months" class="form-input" placeholder="Number of Months (Tenure)" min="1" step="1">
                            <input type="date" id="emi-start-date" class="form-input" placeholder="Start Date">
                        </div>
                        <button type="submit" class="btn btn-primary w-full !mt-6">Add Transaction</button>
                    </form>
                </div>
            </div>

            <!-- Right Column: Lists & Insights -->
            <div class="lg:col-span-2 flex flex-col gap-8">
                <!-- Transactions Lists -->
                <div class="card">
                     <h3 class="text-xl font-bold text-gray-800 mb-4">History</h3>
                     <div id="history-list" class="space-y-4">
                        <!-- All items will be injected here -->
                     </div>
                </div>

                <!-- Cost Cutting Insights -->
                <div class="card">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Statistics</h2>
                    <div class="flex flex-col md:flex-row gap-8 items-center">
                        <div class="w-full md:w-1/2">
                           <canvas id="expenseChart"></canvas>
                        </div>
                        <div id="cost-suggestions" class="w-full md:w-1/2 space-y-3">
                            <p class="text-gray-600">Add some expenses to see your spending breakdown.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="card w-full max-w-md !p-6">
            <p id="modal-message" class="text-gray-700 text-lg mb-6 text-center"></p>
            <div id="modal-buttons" class="flex justify-center gap-4">
                <button id="modal-cancel" class="btn bg-gray-200 hover:bg-gray-300 text-gray-800">Cancel</button>
                <button id="modal-ok" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const transactionForm = document.getElementById('transaction-form');
            const typeSelect = document.getElementById('type');
            const emiFields = document.getElementById('emi-fields');
            const expenseCategoryField = document.getElementById('expense-category-field');
            const exportBtn = document.getElementById('export-btn');

            // Form and EMI calculation elements
            const amountInput = document.getElementById('amount');
            const emiTotal = document.getElementById('emi-total');
            const emiMonths = document.getElementById('emi-months');

            const modal = document.getElementById('custom-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalOk = document.getElementById('modal-ok');
            const modalCancel = document.getElementById('modal-cancel');
            let confirmResolve = null;

            let chartInstance = null;

            let state = {
                incomes: JSON.parse(localStorage.getItem('incomes')) || [],
                expenses: JSON.parse(localStorage.getItem('expenses')) || [],
                emis: JSON.parse(localStorage.getItem('emis')) || []
            };

            // --- Icon Map ---
            const categoryIcons = {
                Food: { svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M21 14v-2a4 4 0 0 0-4-4H9.5a2.5 2.5 0 0 0 0 5H17a4 4 0 0 1 4 4v2"/><path d="M21 18H3"/><path d="M12 11v11"/></svg>`, color: 'bg-orange-100 text-orange-600' },
                Transport: { svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v3c0 .6.4 1 1 1h2"/><path d="M19 17H5v-5a7 7 0 0 1 14 0v5z"/><circle cx="6.5" cy="17.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>`, color: 'bg-blue-100 text-blue-600' },
                Utilities: { svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l.34.34a10 10 0 0 1 0 17.94l-.34.34a10 10 0 0 1 0-17.94Z"/><path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"/></svg>`, color: 'bg-yellow-100 text-yellow-600' },
                Entertainment: { svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 8 4 4-4 4-4-4 4-4z"/><path d="M20 12c0-4.42-3.58-8-8-8s-8 3.58-8 8 3.58 8 8 8 8-3.58 8-8z"/></svg>`, color: 'bg-pink-100 text-pink-600' },
                Shopping: { svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>`, color: 'bg-purple-100 text-purple-600' },
                Health: { svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>`, color: 'bg-red-100 text-red-600' },
                Other: { svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg>`, color: 'bg-gray-100 text-gray-600' }
            };
            const incomeIcon = { svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`, color: 'bg-green-100 text-green-600' };
            const emiIcon = { svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 9a3 3 0 0 1 3-3h14a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V9Z"/><path d="M8 6V4a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2"/><path d="M12 12h.01"/></svg>`, color: 'bg-indigo-100 text-indigo-600' };
            

            // --- Modal Logic ---
            function showModal(message, type = 'alert') {
                modalMessage.textContent = message;
                modalCancel.classList.toggle('hidden', type === 'alert');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                return new Promise((resolve) => { confirmResolve = resolve; });
            }
            function hideModal() {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            modalOk.addEventListener('click', () => { hideModal(); if (confirmResolve) confirmResolve(true); });
            modalCancel.addEventListener('click', () => { hideModal(); if (confirmResolve) confirmResolve(false); });
            
            // --- EMI Auto-calculation ---
            function updateEmiFields() {
                if (typeSelect.value !== 'emi') return;

                const total = parseFloat(emiTotal.value);
                const months = parseInt(emiMonths.value);
                const amount = parseFloat(amountInput.value);
                const activeEl = document.activeElement;

                if (!total || (!months && !amount)) return;

                if (total && months && activeEl.id !== 'amount') {
                    amountInput.value = (total / months).toFixed(2);
                }
                else if (total && amount && activeEl.id !== 'emi-months') {
                    emiMonths.value = Math.ceil(total / amount);
                }
            }
            emiTotal.addEventListener('input', updateEmiFields);
            emiMonths.addEventListener('input', updateEmiFields);
            amountInput.addEventListener('input', updateEmiFields);

            // --- Form & State Logic ---
            typeSelect.addEventListener('change', () => {
                const type = typeSelect.value;
                emiFields.classList.toggle('hidden', type !== 'emi');
                expenseCategoryField.classList.toggle('hidden', type !== 'expense');
                 if (type === 'emi') {
                    amountInput.placeholder = 'Monthly Payment';
                } else {
                    amountInput.placeholder = 'Amount';
                }
            });
            typeSelect.dispatchEvent(new Event('change'));

            transactionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const type = typeSelect.value;
                const name = document.getElementById('name').value;
                const amount = parseFloat(document.getElementById('amount').value);
                const transaction = { id: Date.now(), name, amount, type, date: new Date().toISOString() };

                if (type === 'income') {
                    state.incomes.push(transaction);
                } else if (type === 'expense') {
                    transaction.category = document.getElementById('category').value;
                    state.expenses.push(transaction);
                } else if (type === 'emi') {
                    transaction.total = parseFloat(document.getElementById('emi-total').value);
                    transaction.months = parseInt(document.getElementById('emi-months').value);
                    transaction.startDate = document.getElementById('emi-start-date').value;
                    if (isNaN(transaction.total) || isNaN(transaction.months) || isNaN(transaction.amount) || !transaction.startDate) {
                        showModal('Please ensure all EMI fields are correctly filled.', 'alert');
                        return;
                    }
                    state.emis.push(transaction);
                }
                saveAndRender();
                transactionForm.reset();
                typeSelect.dispatchEvent(new Event('change'));
            });

            function saveState() {
                localStorage.setItem('incomes', JSON.stringify(state.incomes));
                localStorage.setItem('expenses', JSON.stringify(state.expenses));
                localStorage.setItem('emis', JSON.stringify(state.emis));
            }

            function saveAndRender() {
                saveState();
                render();
            }

            // --- Rendering Logic ---
            function render() {
                const totalIncome = state.incomes.reduce((sum, i) => sum + i.amount, 0);
                const totalExpenses = state.expenses.reduce((sum, e) => sum + e.amount, 0);
                const totalEmis = state.emis.reduce((sum, e) => sum + e.amount, 0);
                const cashInHand = totalIncome - totalExpenses - totalEmis;

                document.getElementById('total-income').textContent = `₹${totalIncome.toFixed(2)}`;
                document.getElementById('total-expenses').textContent = `₹${totalExpenses.toFixed(2)}`;
                document.getElementById('total-emis').textContent = `₹${totalEmis.toFixed(2)}`;
                document.getElementById('cash-in-hand').textContent = `₹${cashInHand.toFixed(2)}`;
                
                renderHistoryList();
                renderInsights();
            }
            
            function renderHistoryList() {
                const historyList = document.getElementById('history-list');
                historyList.innerHTML = '';

                const allTransactions = [...state.incomes, ...state.expenses, ...state.emis];
                allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (allTransactions.length === 0) {
                    historyList.innerHTML = `<p class="text-gray-500 italic text-center py-4">No transactions yet.</p>`;
                    return;
                }

                allTransactions.forEach(item => {
                    let iconInfo, amountColor, amountSign;
                    let subtitle = new Date(item.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });

                    if (item.type === 'income') {
                        iconInfo = incomeIcon;
                        amountColor = 'text-green-600';
                        amountSign = '+';
                    } else if (item.type === 'expense') {
                        iconInfo = categoryIcons[item.category] || categoryIcons['Other'];
                        amountColor = 'text-red-600';
                        amountSign = '-';
                        subtitle = `${item.category} · ${subtitle}`;
                    } else { // EMI
                        iconInfo = emiIcon;
                        amountColor = 'text-indigo-600';
                        amountSign = '-';
                        const { remainingMonths, endDateFormatted } = calculateEmiDetails(item);
                        subtitle = remainingMonths > 0 ? `${remainingMonths} of ${item.months} months left · Ends ${endDateFormatted}` : `Completed (${item.months} months)`;
                    }

                    const li = document.createElement('div');
                    li.className = 'flex justify-between items-center';
                    li.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="icon-bg ${iconInfo.color}">
                                ${iconInfo.svg}
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">${item.name}</p>
                                <p class="text-sm text-gray-500">${subtitle}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                           <p class="font-bold text-lg ${amountColor}">${amountSign}₹${item.amount.toFixed(2)}</p>
                           <button class="btn-danger" data-id="${item.id}" data-type="${item.type}s">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                           </button>
                        </div>
                    `;
                    historyList.appendChild(li);
                });
            }

            function calculateEmiDetails(emi) {
                const totalMonths = emi.months;
                const startDate = new Date(emi.startDate);
                const today = new Date();
                startDate.setDate(1);
                today.setDate(1);
                let monthsPassed = (today.getFullYear() - startDate.getFullYear()) * 12 - startDate.getMonth() + today.getMonth();
                const remainingMonths = Math.max(0, totalMonths - monthsPassed - 1);
                const endDate = new Date(startDate);
                endDate.setMonth(startDate.getMonth() + totalMonths - 1);
                const endDateFormatted = endDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                return { remainingMonths, endDateFormatted };
            }

            function renderInsights() {
                const suggestionsContainer = document.getElementById('cost-suggestions');
                const ctx = document.getElementById('expenseChart').getContext('2d');
                
                if (state.expenses.length === 0) {
                    suggestionsContainer.innerHTML = `<p class="text-gray-500">Add some expenses to see your spending breakdown.</p>`;
                    if (chartInstance) chartInstance.destroy();
                    chartInstance = null;
                    return;
                }

                const categorySpending = state.expenses.reduce((acc, expense) => {
                    acc[expense.category] = (acc[expense.category] || 0) + expense.amount;
                    return acc;
                }, {});
                
                const sortedCategories = Object.entries(categorySpending).sort(([, a], [, b]) => b - a);
                suggestionsContainer.innerHTML = '<h3 class="font-semibold text-lg text-gray-800 mb-2">Top Spending:</h3>';
                const suggestionsList = document.createElement('ul');
                suggestionsList.className = 'space-y-3';
                sortedCategories.slice(0, 3).forEach(([category, amount]) => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center text-gray-700';
                    const iconInfo = categoryIcons[category] || categoryIcons['Other'];
                    li.innerHTML = `<div class="icon-bg !w-8 !h-8 mr-3 ${iconInfo.color}">${iconInfo.svg.replace('width="24"','width="20"').replace('height="24"','height="20"')}</div> <span class="font-medium">${category}:</span> <span class="ml-auto font-semibold">₹${amount.toFixed(2)}</span>`;
                    suggestionsList.appendChild(li);
                });
                suggestionsContainer.appendChild(suggestionsList);

                if (chartInstance) {
                    chartInstance.data.labels = Object.keys(categorySpending);
                    chartInstance.data.datasets[0].data = Object.values(categorySpending);
                    chartInstance.update();
                } else {
                    chartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(categorySpending),
                            datasets: [{
                                data: Object.values(categorySpending),
                                backgroundColor: ['#8A2BE2', '#6366F1', '#EC4899', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6'],
                                borderWidth: 0,
                                hoverOffset: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            cutout: '70%',
                            plugins: { legend: { display: false } }
                        }
                    });
                }
            }
            
            // --- Export & Delete ---
            function exportDataToCSV() {
                if (state.incomes.length === 0 && state.expenses.length === 0 && state.emis.length === 0) {
                    showModal('No data to export.', 'alert');
                    return;
                }
                const headers = ['Type', 'Name', 'Amount', 'Category', 'Total Loan', 'Number of Months', 'Start Date', 'Date'];
                let csvContent = headers.join(',') + '\n';
                const formatCell = (d) => `"${String(d==null?'':d).replace(/"/g,'""')}"`;
                const allData = [...state.incomes, ...state.expenses, ...state.emis];
                allData.forEach(item => {
                    const row = [item.type, item.name, item.amount, item.category || '', item.total || '', item.months || '', item.startDate || '', item.date];
                    csvContent += row.map(formatCell).join(',') + '\n';
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.setAttribute("href", URL.createObjectURL(blob));
                link.setAttribute("download", `finance_data_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            exportBtn.addEventListener('click', exportDataToCSV);

            document.getElementById('history-list').addEventListener('click', async (e) => {
                const deleteButton = e.target.closest('.btn-danger');
                if (deleteButton) {
                    const id = parseInt(deleteButton.dataset.id);
                    const type = deleteButton.dataset.type;
                    if (await showModal('Are you sure you want to delete this item?', 'confirm')) {
                        state[type] = state[type].filter(item => item.id !== id);
                        saveAndRender();
                    }
                }
            });

            // Initial render
            render();
        });
    </script>
</body>
</html>

